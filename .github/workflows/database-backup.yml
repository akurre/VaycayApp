name: Database Backup

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read

jobs:
  backup:
    name: Backup Production Database
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Create Database Backup
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway link ${{ secrets.RAILWAY_PROJECT_ID }} --environment production

          # Create backup directory
          mkdir -p backups

          # Generate backup filename with timestamp
          BACKUP_FILE="backups/backup-$(date +%Y-%m-%d-%H%M%S).sql"

          # Create database dump
          railway run --service backend bash -c 'pg_dump $DATABASE_URL' > "$BACKUP_FILE"

          # Compress the backup
          gzip "$BACKUP_FILE"

          echo "âœ… Backup created: ${BACKUP_FILE}.gz"
          ls -lh backups/

      - name: Upload Backup Artifact
        uses: actions/upload-artifact@v5
        with:
          name: database-backup-${{ github.run_number }}
          path: backups/*.sql.gz
          retention-days: 30
          if-no-files-found: error

      - name: Backup Summary
        run: |
          echo "âœ… Database backup completed successfully"
          echo "ðŸ“¦ Backup stored in GitHub Artifacts (retained for 30 days)"
          echo "ðŸ’¡ To restore: Download the artifact and run 'railway run --service backend psql < backup.sql'"

      # Optional: Upload to S3 for longer retention
      # Uncomment and configure if you want to store backups in AWS S3
      # - name: Upload to S3
      #   if: success()
      #   env:
      #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     AWS_REGION: us-east-1
      #   run: |
      #     aws s3 cp backups/ s3://your-backup-bucket/vaycay-backups/ --recursive
